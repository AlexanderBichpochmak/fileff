<!-- NightDLC.csproj -->
<Project Sdk="Uno.Sdk">
    <PropertyGroup>
        <TargetFrameworks>net9.0-windows10.0.26100</TargetFrameworks>
        <OutputType>Exe</OutputType>
        <UnoSingleProject>true</UnoSingleProject>
        <RuntimeIdentifiers>win10-x64</RuntimeIdentifiers>

        <ApplicationTitle>NightDLC Launcher v3</ApplicationTitle>
        <ApplicationId>com.companyname.NightDLC</ApplicationId>
        <ApplicationDisplayVersion>3.0.0</ApplicationDisplayVersion>
        <ApplicationVersion>3</ApplicationVersion>
        <ApplicationPublisher>CodeVerse</ApplicationPublisher>
        <Description>NightDLC powered by WinUI 3 (Uno single project).</Description>

        <TargetPlatformMinVersion>10.0.19041.0</TargetPlatformMinVersion>
        <UseWinUI>true</UseWinUI>
        <EnableDefaultItems>true</EnableDefaultItems>
        <LangVersion>13.0</LangVersion>
        <ApplicationIcon>assets\NightDLC.ico</ApplicationIcon>

        <!-- Метаданные, которые попадают в свойства .exe -->
        <Company>CodeVerse</Company>
        <Product>NightDLC Launcher</Product>
        <Copyright>CodeVerse</Copyright>
        <AssemblyTitle>NightDLC Launcher v3</AssemblyTitle>
        <FileVersion>3.0.0.0</FileVersion>
        <AssemblyVersion>3.0.0.0</AssemblyVersion>
        <Authors>CodeVerse</Authors>
    </PropertyGroup>

    <ItemGroup>
        <Content Include="assets\night.jpg" />
        <Content Include="assets\NightDLC.ico" />
        <Content Include="assets\1.1.2\1.png" />
        <Content Include="assets\1.1.2\2.png" />
        <Content Include="assets\1.1.2\3.png" />
        <Content Include="assets\1.1.3\1.png" />
        <Content Include="assets\1.1.3\2.png" />
        <Content Include="assets\1.1.3\3.png" />
    </ItemGroup>
</Project>



<!-- App.xaml -->
<Application x:Class="NightDLC.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="using:Microsoft.UI.Xaml.Controls"
             RequestedTheme="Dark">

    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <XamlControlsResources xmlns="using:Microsoft.UI.Xaml.Controls" />
            </ResourceDictionary.MergedDictionaries>

            <AcrylicBrush x:Key="AcrylicCardBrush"
                    TintColor="#222838"
                    TintOpacity="0.55"
                    TintLuminosityOpacity="0.18"
                    FallbackColor="#242A3A" />

            <AcrylicBrush x:Key="AcrylicPanelBrush"
                    TintColor="#1E2332"
                    TintOpacity="0.50"
                    TintLuminosityOpacity="0.16"
                    FallbackColor="#1E2332" />

            <TransitionCollection x:Key="DefaultTransitions">
                <EntranceThemeTransition />
                <RepositionThemeTransition />
                <ContentThemeTransition />
            </TransitionCollection>

            <Style x:Key="TitleBarSquareButtonBaseStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent" />
                <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}" />
                <Setter Property="BorderBrush" Value="{ThemeResource SystemControlTransparentBrush}" />
                <Setter Property="BorderThickness" Value="0" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="CornerRadius" Value="0" />
                <Setter Property="HorizontalAlignment" Value="Stretch" />
                <Setter Property="VerticalAlignment" Value="Stretch" />
                <Setter Property="MinWidth" Value="40" />
                <Setter Property="MinHeight" Value="40" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Grid x:Name="RootGrid" Background="{TemplateBinding Background}">
                                <ContentPresenter HorizontalAlignment="Center"
                                  VerticalAlignment="Center"
                                  Content="{TemplateBinding Content}" />
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup x:Name="CommonStates">
                                        <VisualState x:Name="Normal" />
                                        <VisualState x:Name="PointerOver">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background" Value="#333742" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="Pressed">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background" Value="#262A34" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="Disabled">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Opacity" Value="0.6" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="TitleBarCloseButtonStyle"
             BasedOn="{StaticResource TitleBarSquareButtonBaseStyle}"
             TargetType="Button">
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Grid x:Name="RootGrid" Background="{TemplateBinding Background}">
                                <ContentPresenter HorizontalAlignment="Center"
                                  VerticalAlignment="Center"
                                  Content="{TemplateBinding Content}" />
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup x:Name="CommonStates">
                                        <VisualState x:Name="Normal" />
                                        <VisualState x:Name="PointerOver">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background" Value="#E81123" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="Pressed">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Background" Value="#C50F1F" />
                                            </VisualState.Setters>
                                        </VisualState>
                                        <VisualState x:Name="Disabled">
                                            <VisualState.Setters>
                                                <Setter Target="RootGrid.Opacity" Value="0.6" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

        </ResourceDictionary>
    </Application.Resources>
</Application>



// App.xaml.cs
using System;
using System.Runtime.InteropServices;
using Microsoft.UI.Composition.SystemBackdrops;
using Microsoft.UI.Windowing;
using Microsoft.UI.Xaml;
using Microsoft.UI.Xaml.Controls;
using Microsoft.UI.Xaml.Navigation;
using WinRT.Interop;
using Windows.Graphics;

namespace NightDLC;

public partial class App : Application
{
    public App() => InitializeComponent();

    public static Window? CurrentWindow { get; private set; }

    protected override void OnLaunched(LaunchActivatedEventArgs args)
    {
        var window = new Window();
        CurrentWindow = window;

        TryEnableMica(window);
        ConfigurePresenterStrict(window);

        window.ExtendsContentIntoTitleBar = true;
        TrySetTitle(window, "NightDLC Launcher v3");
        SizeAndCenterWindow(window, 1220, 700);

        var frame = new Frame { Background = null };
        frame.NavigationFailed += OnNavigationFailed;
        frame.Navigated += OnRootFrameNavigated;
        frame.Navigate(typeof(MainPage));

        window.Content = frame;
        window.Activate();
    }

    private static void TryEnableMica(Window window)
    {
        try { window.SystemBackdrop = new MicaBackdrop(); } catch { }
    }

    private static void ConfigurePresenterStrict(Window window)
    {
        try
        {
            var hwnd = WindowNative.GetWindowHandle(window);
            var windowId = Microsoft.UI.Win32Interop.GetWindowIdFromWindow(hwnd);
            var appWindow = AppWindow.GetFromWindowId(windowId);
            if (appWindow.Presenter is OverlappedPresenter p)
            {
                p.SetBorderAndTitleBar(hasBorder: true, hasTitleBar: false);
                p.IsResizable = false;
                p.IsMaximizable = false;
                p.IsMinimizable = true;
            }
        }
        catch { }
    }

    private static void TrySetTitle(Window window, string title)
    {
        try
        {
            var hwnd = WindowNative.GetWindowHandle(window);
            var windowId = Microsoft.UI.Win32Interop.GetWindowIdFromWindow(hwnd);
            var appWindow = AppWindow.GetFromWindowId(windowId);
            appWindow.Title = title;
        }
        catch { }
    }

    private static void SizeAndCenterWindow(Window window, int width, int height)
    {
        try
        {
            var hwnd = WindowNative.GetWindowHandle(window);
            var windowId = Microsoft.UI.Win32Interop.GetWindowIdFromWindow(hwnd);
            var appWindow = AppWindow.GetFromWindowId(windowId);

            var displayArea = DisplayArea.GetFromWindowId(windowId, DisplayAreaFallback.Primary);
            var wa = displayArea.WorkArea;
            var x = wa.X + (wa.Width - width) / 2;
            var y = wa.Y + (wa.Height - height) / 2;

            appWindow.Resize(new SizeInt32(width, height));
            appWindow.Move(new PointInt32(x, y));
        }
        catch { }
    }

    private static void OnRootFrameNavigated(object sender, NavigationEventArgs e)
    {
        if (e.Content is MainPage page && CurrentWindow is not null)
        {
            try
            {
                CurrentWindow.ExtendsContentIntoTitleBar = true;
                CurrentWindow.SetTitleBar(page.TitleBarDragArea);
            }
            catch { }
        }
    }

    private static void OnNavigationFailed(object sender, NavigationFailedEventArgs e)
    {
        throw new InvalidOperationException($"Failed to load {e.SourcePageType.FullName}: {e.Exception}");
    }

    [DllImport("user32.dll")]
    private static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);

    public static void MinimizeCurrentWindow()
    {
        var win = CurrentWindow;
        if (win is null) return;
        var hwnd = WindowNative.GetWindowHandle(win);
        const int SW_MINIMIZE = 6;
        ShowWindow(hwnd, SW_MINIMIZE);
    }

    [DllImport("user32.dll")]
    private static extern bool SetForegroundWindow(IntPtr hWnd);

    public static void RestoreCurrentWindow()
    {
        var win = CurrentWindow;
        if (win is null) return;
        var hwnd = WindowNative.GetWindowHandle(win);
        const int SW_RESTORE = 9;
        ShowWindow(hwnd, SW_RESTORE);
    }

    public static void CloseCurrentWindow() => CurrentWindow?.Close();
}



<!-- MainPage.xaml -->
/Page x:Class="NightDLC.MainPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:controls="using:Microsoft.UI.Xaml.Controls"
      Background="{x:Null}">

<Grid Background="{x:Null}">
    <Grid.RowDefinitions>
        <RowDefinition Height="40" />
        <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- Title bar -->
    <Grid x:Name="AppTitleBar"
          Grid.Row="0"
          Background="{ThemeResource LayerFillColorDefaultBrush}"
          Height="40"
          Transitions="{StaticResource DefaultTransitions}"
          DoubleTapped="OnTitleBarDoubleTapped">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="40" />
            <ColumnDefinition Width="40" />
        </Grid.ColumnDefinitions>

        <Grid x:Name="TitleBarDragAreaHost" Grid.Column="0">
            <StackPanel Orientation="Horizontal"
                    VerticalAlignment="Center"
                    Spacing="10"
                    Margin="12,0,0,0">
                <TextBlock Text="NightDLC Launcher v3"
                     FontSize="15"
                     FontWeight="Bold"
                     Opacity="0.98"/>
            </StackPanel>
        </Grid>

        <Button Grid.Column="1"
              Width="40" Height="40"
              Click="OnMinimizeClick"
              Style="{StaticResource TitleBarSquareButtonBaseStyle}"
              ToolTipService.ToolTip="Свернуть">
            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE921;" FontSize="10"/>
        </Button>

        <Button Grid.Column="2"
              Width="40" Height="40"
              Click="OnCloseClick"
              Style="{StaticResource TitleBarCloseButtonStyle}"
              ToolTipService.ToolTip="Закрыть">
            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE8BB;" FontSize="10"/>
        </Button>
    </Grid>

    <!-- NavigationView -->
    <controls:NavigationView x:Name="NavView"
                             Grid.Row="1"
                             IsSettingsVisible="False"
                             PaneDisplayMode="Left"
                             IsBackButtonVisible="Collapsed"
                             OpenPaneLength="260"
                             CompactPaneLength="56"
                             Background="Transparent"
                             Transitions="{StaticResource DefaultTransitions}">
        <controls:NavigationView.MenuItems>
            <controls:NavigationViewItem Content="Главная" Tag="home">
                <controls:NavigationViewItem.Icon>
                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE80F;"/>
                </controls:NavigationViewItem.Icon>
            </controls:NavigationViewItem>

            <controls:NavigationViewItem Content="Настройки" Tag="settings">
                <controls:NavigationViewItem.Icon>
                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE713;"/>
                </controls:NavigationViewItem.Icon>
            </controls:NavigationViewItem>

            <controls:NavigationViewItem Content="О программе" Tag="about">
                <controls:NavigationViewItem.Icon>
                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE946;"/>
                </controls:NavigationViewItem.Icon>
            </controls:NavigationViewItem>
        </controls:NavigationView.MenuItems>

        <Grid Background="Transparent">
            <Canvas x:Name="StarsCanvas"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                IsHitTestVisible="False"/>

            <!-- Home -->
            <Grid x:Name="SectionHome"
              Visibility="Visible"
              Opacity="1"
              Background="{x:Null}"
              Transitions="{StaticResource DefaultTransitions}">
                <Grid>
                    <Grid x:Name="CardsGrid"
                  Opacity="1"
                  Visibility="Visible"
                  Margin="20,12,20,20"
                  Background="{x:Null}"
                  Transitions="{StaticResource DefaultTransitions}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Card 1.1.2 -->
                        <Grid Grid.Column="0">
                            <Border x:Name="Card112"
                        Background="{StaticResource AcrylicCardBrush}"
                        CornerRadius="16" Padding="0"
                        Width="440" Height="410"
                        Opacity="0.98"
                        BorderThickness="2"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="220" />
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <Image x:Name="Cover112"
                           Source="ms-appx:///assets/1.1.2/1.png"
                           Stretch="UniformToFill"
                           Grid.Row="0"
                           Margin="0,0,0,12"/>
                                    <Rectangle Grid.Row="0" Fill="#55000000"/>

                                    <StackPanel Grid.Row="1" Padding="16" Spacing="8" Background="{x:Null}">
                                        <TextBlock Text="NightDLC 1.1.2 Release" FontSize="22" FontWeight="SemiBold"/>
                                        <TextBlock Text="Стабильная сборка 1.16.5" Opacity="0.85"/>
                                        <TextBlock
                        Text="Самая стабильная версия NightDLC на майнкрафт 1.16.5 с интерфейсом Нурсултан. Подробнее в карточке."
                        TextWrapping="WrapWholeWords"
                        Opacity="0.92"/>
                                    </StackPanel>

                                    <StackPanel Grid.Row="2"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Spacing="8"
                                Padding="16"
                                Background="{x:Null}">
                                        <Button Style="{ThemeResource AccentButtonStyle}"
                              Padding="12,6"
                              CornerRadius="8"
                              Click="OnOpenProduct112Release">
                                            <Button.Content>
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE8A7;"/>
                                                    <TextBlock Text="Подробнее"/>
                                                </StackPanel>
                                            </Button.Content>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </Grid>

                        <!-- Card 1.1.3 -->
                        <Grid Grid.Column="1">
                            <Border x:Name="Card113"
                        Background="{StaticResource AcrylicCardBrush}"
                        CornerRadius="16" Padding="0"
                        Width="440" Height="410"
                        Opacity="0.98"
                        BorderThickness="2"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="220" />
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <Image x:Name="Cover113"
                           Source="ms-appx:///assets/1.1.3/1.png"
                           Stretch="UniformToFill"
                           Grid.Row="0"
                           Margin="0,0,0,12"/>
                                    <Rectangle Grid.Row="0" Fill="#55000000"/>

                                    <StackPanel Grid.Row="1" Padding="16" Spacing="8" Background="{x:Null}">
                                        <TextBlock Text="NightDLC 1.1.3 Client" FontSize="22" FontWeight="SemiBold"/>
                                        <TextBlock Text="Последняя версия 1.16.5" Opacity="0.85"/>
                                        <TextBlock
                        Text="Много улучшений, новые режимы, умные криты, помощники и визуальные обновления. Подробнее в карточке."
                        TextWrapping="WrapWholeWords"
                        Opacity="0.92"/>
                                    </StackPanel>

                                    <StackPanel Grid.Row="2"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Spacing="8"
                                Padding="16"
                                Background="{x:Null}">
                                        <Button Style="{ThemeResource AccentButtonStyle}"
                              Padding="12,6"
                              CornerRadius="8"
                              Click="OnOpenProduct113Client">
                                            <Button.Content>
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE8A7;"/>
                                                    <TextBlock Text="Подробнее"/>
                                                </StackPanel>
                                            </Button.Content>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </Grid>
                    </Grid>
                </Grid>
            </Grid>

            <!-- Product -->
            <Grid x:Name="SectionProduct"
              Visibility="Collapsed"
              Opacity="0"
              Background="{x:Null}"
              Transitions="{StaticResource DefaultTransitions}">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Background="Transparent">
                    <StackPanel Spacing="16" Padding="16" Background="Transparent">
                        <Grid Background="{StaticResource AcrylicPanelBrush}" CornerRadius="12" Padding="12">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="220" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <Image x:Name="ProductHeroCover"
                       Grid.Row="0"
                       Stretch="UniformToFill"
                       Source="ms-appx:///assets/1.1.2/1.png"
                       Margin="0,0,0,16"/>

                            <Grid Grid.Row="1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <Button Padding="8" CornerRadius="6"
                          Click="OnBackToHome"
                          ToolTipService.ToolTip="Назад">
                                    <Button.Content>
                                        <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE72B;" FontSize="14"/>
                                    </Button.Content>
                                </Button>

                                <Border Grid.Column="1"
                          HorizontalAlignment="Left"
                          Margin="12,0,0,0"
                          Width="50" Height="50"
                          CornerRadius="8"
                          Background="{StaticResource AcrylicCardBrush}">
                                    <Image x:Name="ProductIcon" Source="ms-appx:///assets/night.jpg" Stretch="UniformToFill"/>
                                </Border>

                                <StackPanel Grid.Column="1"
                              Orientation="Vertical"
                              Margin="70,0,0,0"
                              Spacing="2"
                              Background="{x:Null}">
                                    <TextBlock x:Name="ProductTitle_Header"
                               Text="NightDLC Launcher v3"
                               FontSize="20"
                               FontWeight="SemiBold"/>
                                    <TextBlock x:Name="ProductSubtitle_Header"
                               Text="Карточка товара"
                               Opacity="0.7"/>
                                </StackPanel>

                                <Button Grid.Column="2"
                          Padding="8"
                          CornerRadius="6"
                          ToolTipService.ToolTip="Меню"
                          Click="OnProductMenuClick">
                                    <Button.Content>
                                        <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE10C;" FontSize="14"/>
                                    </Button.Content>
                                </Button>
                            </Grid>
                        </Grid>

                        <Border Background="{StaticResource AcrylicCardBrush}" CornerRadius="12" Padding="12">
                            <StackPanel Orientation="Horizontal" Spacing="10" Background="{x:Null}">
                                <Button x:Name="LaunchOrDownloadButton"
                          Style="{ThemeResource AccentButtonStyle}"
                          Padding="16,8"
                          CornerRadius="8"
                          Click="OnPrimaryActionClick">
                                    <Button.Content>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon x:Name="PrimaryActionIcon" FontFamily="Segoe Fluent Icons" Glyph="&#xE768;"/>
                                            <TextBlock x:Name="PrimaryActionText" Text="Запустить"/>
                                        </StackPanel>
                                    </Button.Content>
                                </Button>

                                <Button Style="{ThemeResource AccentButtonStyle}"
                          Padding="16,8"
                          CornerRadius="8"
                          Click="OnEditAllocForProduct">
                                    <Button.Content>
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE70F;"/>
                                            <TextBlock Text="Редактировать ОЗУ"/>
                                        </StackPanel>
                                    </Button.Content>
                                </Button>
                            </StackPanel>
                        </Border>

                        <Border x:Name="DownloadContainerBorder"
                      Background="{StaticResource AcrylicCardBrush}"
                      CornerRadius="12"
                      Padding="12"
                      Opacity="0"
                      Visibility="Collapsed">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Загрузка клиента" FontSize="18" FontWeight="SemiBold"/>
                                <ProgressBar x:Name="DownloadProgressBar" Minimum="0" Maximum="100" Value="0"/>
                                <StackPanel Orientation="Vertical" Spacing="4">
                                    <TextBlock x:Name="DownloadProgressText" Text="0.00 / 0.00 MB (0%)"/>
                                    <TextBlock x:Name="DownloadSpeedText" Text="Скорость: 0.00 MB/s"/>
                                    <TextBlock x:Name="DownloadEtaText" Text="Осталось: —"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Screenshots -->
                        <StackPanel Spacing="8" Background="{x:Null}">
                            <TextBlock Text="Скриншоты" FontSize="18" FontWeight="SemiBold"/>
                            <Grid Background="{x:Null}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <Border Grid.Column="0"
                          Background="{StaticResource AcrylicCardBrush}"
                          CornerRadius="12"
                          Padding="8"
                          Margin="0,0,8,0">
                                    <Image x:Name="Shot1"
                           Source="ms-appx:///assets/1.1.2/1.png"
                           Stretch="UniformToFill"
                           Height="160"
                           Tapped="OnShotTapped"/>
                                </Border>

                                <Border Grid.Column="1"
                          Background="{StaticResource AcrylicCardBrush}"
                          CornerRadius="12"
                          Padding="8"
                          Margin="0,0,8,0">
                                    <Image x:Name="Shot2"
                           Source="ms-appx:///assets/1.1.2/2.png"
                           Stretch="UniformToFill"
                           Height="160"
                           Tapped="OnShotTapped"/>
                                </Border>

                                <Border Grid.Column="2"
                          Background="{StaticResource AcrylicCardBrush}"
                          CornerRadius="12"
                          Padding="8">
                                    <Image x:Name="Shot3"
                           Source="ms-appx:///assets/1.1.2/3.png"
                           Stretch="UniformToFill"
                           Height="160"
                           Tapped="OnShotTapped"/>
                                </Border>
                            </Grid>
                        </StackPanel>

                        <!-- Description -->
                        <Border Background="{StaticResource AcrylicCardBrush}" CornerRadius="12" Padding="12">
                            <StackPanel Spacing="10">
                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE8F1;" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                                    <TextBlock Text="Описание версии" FontSize="18" FontWeight="SemiBold"/>
                                </StackPanel>

                                <Rectangle Height="1" Fill="{ThemeResource CardStrokeColorDefaultBrush}" Opacity="0.5"/>

                                <Border Background="{ThemeResource SystemFillColorAttentionBackgroundBrush}"
                          CornerRadius="10" Padding="10">
                                    <StackPanel Spacing="8">
                                        <TextBlock x:Name="ProductDescriptionCollapsed"
                                 Text=""
                                 TextWrapping="WrapWholeWords"
                                 MaxLines="8"
                                 TextTrimming="CharacterEllipsis"
                                 Visibility="Visible"/>
                                        <TextBlock x:Name="ProductDescriptionFull"
                                 Text=""
                                 TextWrapping="WrapWholeWords"
                                 Visibility="Collapsed"/>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                            <Button x:Name="ShowMoreButton"
                                Content="Показать больше"
                                Padding="12,6"
                                CornerRadius="8"
                                Click="OnToggleShowMore"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <!-- Settings -->
            <Grid x:Name="SectionSettings"
              Visibility="Collapsed"
              Opacity="0"
              Background="{x:Null}"
              Transitions="{StaticResource DefaultTransitions}">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Background="Transparent">
                    <StackPanel Spacing="16" Padding="16" Background="{x:Null}">
                        <TextBlock x:Name="SystemRamInfo" Text="ОЗУ: —" FontSize="20" FontWeight="Bold"/>

                        <Border Background="{StaticResource AcrylicCardBrush}" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="12" Background="{x:Null}">
                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE7F8;"/>
                                    <TextBlock Text="Параметры запуска" FontSize="16" FontWeight="SemiBold"/>
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                    <TextBlock Text="Версия:" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="VersionSelect" SelectionChanged="OnVersionSelectionChanged" Width="220">
                                        <ComboBoxItem Content="NightDLC 1.1.2" Tag="v112" IsSelected="True"/>
                                        <ComboBoxItem Content="NightDLC 1.1.3" Tag="v113"/>
                                    </ComboBox>
                                </StackPanel>

                                <StackPanel Spacing="6">
                                    <TextBlock x:Name="AllocLabel" Text="Выделение: —"/>
                                    <Slider x:Name="AllocSlider"
                            Minimum="1"
                            Maximum="64"
                            ValueChanged="OnAllocChanged"
                            SmallChange="1"
                            LargeChange="2"/>
                                </StackPanel>

                                <controls:InfoBar x:Name="WarningBar"
                                    IsOpen="False"
                                    IsClosable="True"
                                    Severity="Warning"
                                    Title="Предупреждение"
                                    Message="Выделено более 50% ОЗУ. Рекомендуется уменьшить."/>
                                <controls:InfoBar x:Name="ErrorBar"
                                    IsOpen="False"
                                    IsClosable="True"
                                    Severity="Error"
                                    Title="Высокое выделение памяти"
                                    Message="Выделено более 80% ОЗУ. Рекомендуется уменьшить."/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <!-- About -->
            <Grid x:Name="SectionAbout"
              Visibility="Collapsed"
              Opacity="0"
              Background="{x:Null}"
              Transitions="{StaticResource DefaultTransitions}">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Background="Transparent">
                    <StackPanel Spacing="12" Padding="16" Background="{x:Null}">
                        <TextBlock Text="О программе" FontSize="20" FontWeight="Bold"/>
                        <Border Background="{StaticResource AcrylicCardBrush}" CornerRadius="12" Padding="16">
                            <StackPanel Spacing="10" Background="{x:Null}">
                                <TextBlock Text="NightDLC Launcher v3" FontSize="18" FontWeight="SemiBold"/>
                                <TextBlock Text="Информация и ссылки" Opacity="0.8"/>

                                <!-- Текстовые ссылки без иконок -->
                                <StackPanel Orientation="Vertical" Spacing="6">
                                    <HyperlinkButton Padding="0"
                                     NavigateUri="https://t.me/Night_DLCC"
                                     ToolTipService.ToolTip="Telegram NightDLC">
                                        <TextBlock Text="Telegram NightDLC"/>
                                    </HyperlinkButton>

                                    <HyperlinkButton Padding="0"
                                     NavigateUri="https://discord.gg/Y3x2CMuGZ7"
                                     ToolTipService.ToolTip="Discord NightDLC">
                                        <TextBlock Text="Discord NightDLC"/>
                                    </HyperlinkButton>
                                </StackPanel>

                                <!-- Автор: Hyperlink в TextBlock, контекстное меню только Telegram CodeVerse -->
                                <TextBlock x:Name="AuthorTextBlock">
                    <Run Text="Данное приложение разработано разработчиком " />
                    <Hyperlink Click="OnAuthorHyperlinkClick">
                      <Run Text="AlexPochmak"/>
                    </Hyperlink>
                    <Run Text="."/>
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <!-- Overlay -->
            <Grid x:Name="ScreenshotOverlay"
              Visibility="Collapsed"
              Opacity="0"
              IsHitTestVisible="False"
              Canvas.ZIndex="1000">
                <Rectangle Fill="#99000000"/>
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                    <Image x:Name="OverlayImage"
                   Stretch="Uniform"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   MaxWidth="1000"
                   MaxHeight="650"/>
                    <Button x:Name="OverlayCloseBtn"
                    Width="36" Height="36"
                    HorizontalAlignment="Right" VerticalAlignment="Top"
                    Margin="16"
                    ToolTipService.ToolTip="Закрыть"
                    Click="OnOverlayClose">
                        <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE8BB;" FontSize="12"/>
                    </Button>
                    <Button x:Name="OverlayPrevBtn"
                    Width="48" Height="48"
                    HorizontalAlignment="Left" VerticalAlignment="Center"
                    Margin="16"
                    ToolTipService.ToolTip="Назад"
                    Click="OnOverlayPrev">
                        <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE76B;" FontSize="18"/>
                    </Button>
                    <Button x:Name="OverlayNextBtn"
                    Width="48" Height="48"
                    HorizontalAlignment="Right" VerticalAlignment="Center"
                    Margin="16"
                    ToolTipService.ToolTip="Вперёд"
                    Click="OnOverlayNext">
                        <FontIcon FontFamily="Segoe Fluent Icons" Glyph="&#xE76C;" FontSize="18"/>
                    </Button>
                    <Border HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,24"
                    Background="{StaticResource AcrylicCardBrush}" CornerRadius="12" Padding="12,6">
                        <TextBlock x:Name="OverlayCounter" Text="1 / 3" FontWeight="SemiBold"/>
                    </Border>
                </Grid>
            </Grid>
        </Grid>
    </controls:NavigationView>
</Grid>
</Page>



// MainPage.xaml.cs
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.IO.Compression;
using System.Linq;
using System.Net.Http;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.UI.Dispatching;
using Microsoft.UI.Windowing;
using Microsoft.UI.Xaml;
using Microsoft.UI.Xaml.Controls;
using Microsoft.UI.Xaml.Controls.Primitives;
using Microsoft.UI.Xaml.Input;
using Microsoft.UI.Xaml.Media;
using Microsoft.UI.Xaml.Media.Animation;
using Microsoft.UI.Xaml.Media.Imaging;
using Microsoft.UI.Xaml.Shapes;
using Microsoft.UI.Xaml.Documents;
using Windows.Foundation;
using Windows.ApplicationModel.DataTransfer;
using IOPath = System.IO.Path;

namespace NightDLC;

public sealed partial class MainPage : Page
{
    private enum ProductId { None, Night112Release, Night113Client }

    private ProductId _currentProduct = ProductId.None;
    private ulong _totalRamBytes;
    private int _allocGb112 = 4;
    private int _allocGb113 = 4;

    private readonly Random _rand = new();
    private readonly List<Ellipse> _stars = new();
    private bool _starsInitialized;

    private static readonly SemaphoreSlim DialogLock = new(1, 1);
    private static readonly HttpClient Http = new();

    private bool _isDownloading;
    private CancellationTokenSource? _downloadCts;

    private readonly string _desc113 =
        "Обновления NightDLC Client 1.1.3\r\n" +
        "Обновлена Aura; обновлены ротации: \"FunT1me\", \"Ho1yWor1d\", \"SpookyT1me\".\r\n\r\n" +
        "Обновлена крит-система, добавлен «Кулдаун атаки», улучшены умные криты.\r\n\r\n" +
        "Обновлён FunT1meHelper, Auto GPS Event, добавлены типы меток и настройки.\r\n\r\n" +
        "Добавлен «Обход SpookyT1me», проекции для эффектов, таймеры.\r\n\r\n" +
        "Обновлены AutoSwap, AutoTotem, режимы FunT1me/SpookyT1me; добавлен GrimLightning.\r\n\r\n" +
        "Редизайн Hud/ClickGui, обновлён MainMenu/AltManager.\r\n\r\n" +
        "AhHelper, WaterSpeed (All/FunT1me), BowHelper.\r\n\r\n" +
        "TargetPearl, Bariton; удалены/заменены устаревшие функции.\r\n\r\n" +
        "Временно удалены HitEffect, ClientPlayerHud, AutoBuy.";

    private readonly string _desc112 =
        "Обновление NightDLC RELEASE v1.1.2\r\n" +
        "AttackAura, ротации FunTime/SpookyTime/Matrix/Grim.\r\n\r\n" +
        "Исправления щита; типы спринта: Легитный/HVH/Блант.\r\n\r\n" +
        "AutoSwap/AutoTotem/«Обход»; настройки зачарованных.\r\n\r\n" +
        "BeckTreck/TargetStrafe; криты; HitEffect.\r\n\r\n" +
        "GlassHand; Interface/ClickGui (Nursultan); Spider.\r\n\r\n" +
        "ElytraHelper; Notifications; AucHelper; NoWeb.\r\n\r\n" +
        "Удалены TargetPearl, EggMan; фикс критической ошибки ПКМ.";

    private List<string> _currentScreenshots = new();
    private int _overlayIndex = 0;

    public MainPage()
    {
        InitializeComponent();

        var nav = NavView;
        if (nav != null)
        {
            nav.SelectionChanged += OnNavSelectionChanged;
            nav.SelectedItem = nav.MenuItems[0];
        }

        Loaded += OnPageLoaded;
        Unloaded += OnPageUnloaded;

        ApplyCardHoverEffects();

        KeyDown += OnPageKeyDown;

        ResetDownloadUi();
    }

    public UIElement TitleBarDragArea => TitleBarDragAreaHost as UIElement ?? this;

    private void OnTitleBarDoubleTapped(object sender, DoubleTappedRoutedEventArgs e) => e.Handled = true;

    private void OnPageLoaded(object? sender, RoutedEventArgs e)
    {
        _totalRamBytes = GetTotalPhysicalMemory();
        HookSettingsControlsLoaded();
        EnsureStarsInitialized();
        CompositionTarget.Rendering += OnStarsRender;
        InitializeLaunchParamsUI();
    }

    private void OnPageUnloaded(object? sender, RoutedEventArgs e)
    {
        CompositionTarget.Rendering -= OnStarsRender;
        _stars.Clear();
        StarsCanvas?.Children.Clear();
        KeyDown -= OnPageKeyDown;
    }

    private void OnPageKeyDown(object? sender, KeyRoutedEventArgs e)
    {
        if (ScreenshotOverlay?.Visibility != Visibility.Visible) return;

        if (e.Key == Windows.System.VirtualKey.Escape)
        {
            CloseOverlay();
            e.Handled = true;
        }
        else if (e.Key == Windows.System.VirtualKey.Left)
        {
            OverlayStep(-1);
            e.Handled = true;
        }
        else if (e.Key == Windows.System.VirtualKey.Right)
        {
            OverlayStep(1);
            e.Handled = true;
        }
    }

    private void OnMinimizeClick(object? s, RoutedEventArgs e) => App.MinimizeCurrentWindow();
    private void OnCloseClick(object? s, RoutedEventArgs e) => App.CloseCurrentWindow();

    private bool _settingsLoadedOnce;

    private void HookSettingsControlsLoaded()
    {
        if (_settingsLoadedOnce) return;

        VersionSelect.Loaded += (s, e) => TryInitializeSettingsUI();
        AllocSlider.Loaded += (s, e) => TryInitializeSettingsUI();
        WarningBar.Loaded += (s, e) => TryInitializeSettingsUI();
        ErrorBar.Loaded += (s, e) => TryInitializeSettingsUI();
        AllocLabel.Loaded += (s, e) => TryInitializeSettingsUI();

        TryInitializeSettingsUI();
    }

    private void TryInitializeSettingsUI()
    {
        if (VersionSelect == null || AllocSlider == null || AllocLabel == null || WarningBar == null || ErrorBar == null)
            return;

        DispatcherQueue.TryEnqueue(() =>
        {
            InitializeLaunchParamsUI();
            _settingsLoadedOnce = true;
        });
    }

    private void InitializeLaunchParamsUI()
    {
        var totalGb = BytesToGb(_totalRamBytes);

        if (SystemRamInfo != null)
            SystemRamInfo.Text = _totalRamBytes == 0 ? "ОЗУ: не удалось определить" : $"ОЗУ: {totalGb} ГБ";

        var maxGb = Math.Max(4, (int)Math.Min(64, Math.Max(8, (int)(totalGb * 0.9))));
        if (AllocSlider != null)
        {
            AllocSlider.Maximum = maxGb;
            AllocSlider.Minimum = 1;
        }

        _allocGb112 = 4;
        _allocGb113 = 4;

        SetAllocSliderBySelectedVersion();
        UpdateAllocLabelsAndWarnings();
    }

    private static int BytesToGb(ulong bytes) =>
        (int)Math.Round(bytes / (1024.0 * 1024 * 1024), MidpointRounding.AwayFromZero);

    private void SetAllocSliderBySelectedVersion()
    {
        if (AllocSlider == null || VersionSelect == null) return;

        var tag = (VersionSelect.SelectedItem as ComboBoxItem)?.Tag as string ?? "v112";
        int gb = tag == "v113" ? _allocGb113 : _allocGb112;
        double clamped = Math.Max(AllocSlider.Minimum, Math.Min(AllocSlider.Maximum, gb));
        AllocSlider.Value = clamped;
    }

    private void OnVersionSelectionChanged(object? s, SelectionChangedEventArgs e)
    {
        if (AllocSlider == null || VersionSelect == null) return;

        SetAllocSliderBySelectedVersion();
        UpdateAllocLabelsAndWarnings();

        var gb = (int)Math.Round(AllocSlider.Value);
        var tag = (VersionSelect.SelectedItem as ComboBoxItem)?.Tag as string ?? "v112";
        if (tag == "v113") _allocGb113 = gb; else _allocGb112 = gb;
    }

    private async void OnAllocChanged(object? s, RangeBaseValueChangedEventArgs e)
    {
        if (AllocSlider == null || VersionSelect == null) return;

        var gb = (int)Math.Round(AllocSlider.Value);
        var tag = (VersionSelect.SelectedItem as ComboBoxItem)?.Tag as string ?? "v112";
        if (tag == "v113") _allocGb113 = gb; else _allocGb112 = gb;

        UpdateAllocLabelsAndWarnings();
        await UpdateBatRamForSelectedVersionIfInstalledAsync();
    }

    private void UpdateAllocLabelsAndWarnings()
    {
        if (AllocSlider == null || AllocLabel == null || WarningBar == null || ErrorBar == null) return;

        var gb = (int)Math.Round(AllocSlider.Value);
        var totalGb = BytesToGb(_totalRamBytes);

        double percent = (_totalRamBytes == 0 || totalGb == 0) ? 0.0 : (gb / (double)totalGb) * 100.0;

        AllocLabel.Text = $"Выделение: {gb} ГБ ({percent:0}% от ОЗУ)";
        WarningBar.IsOpen = percent > 50.0 && percent <= 80.0;
        ErrorBar.IsOpen = percent > 80.0;
    }

    private void ApplyCardHoverEffects()
    {
        var accentBrush = (Brush)Application.Current.Resources["AccentFillColorDefaultBrush"];
        var defaultStroke = (Brush)Application.Current.Resources["CardStrokeColorDefaultBrush"];

        var card112 = Card112;
        var card113 = Card113;

        if (card112 != null) ApplyHover(card112, defaultStroke, accentBrush);
        if (card113 != null) ApplyHover(card113, defaultStroke, accentBrush);
    }

    private void ApplyHover(Border card, Brush defaultStroke, Brush accentStroke)
    {
        card.BorderBrush = defaultStroke;

        var transform = new ScaleTransform { ScaleX = 1.0, ScaleY = 1.0 };
        card.RenderTransformOrigin = new Point(0.5, 0.5);
        card.RenderTransform = transform;

        card.PointerEntered += (s, e) =>
        {
            AnimateScale(transform, transform.ScaleX, 1.02, 140);
            AnimateOpacity(card, card.Opacity, 1.0, 140);
            card.BorderBrush = accentStroke;
        };

        card.PointerExited += (s, e) =>
        {
            AnimateScale(transform, transform.ScaleX, 1.0, 140);
            AnimateOpacity(card, card.Opacity, 0.98, 140);
            card.BorderBrush = defaultStroke;
        };
    }

    private void AnimateScale(ScaleTransform transform, double from, double to, int ms)
    {
        var ax = new DoubleAnimation
        {
            From = from,
            To = to,
            Duration = TimeSpan.FromMilliseconds(ms),
            EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseOut }
        };
        var ay = new DoubleAnimation
        {
            From = from,
            To = to,
            Duration = TimeSpan.FromMilliseconds(ms),
            EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseOut }
        };
        Storyboard.SetTarget(ax, transform);
        Storyboard.SetTargetProperty(ax, "ScaleX");
        Storyboard.SetTarget(ay, transform);
        Storyboard.SetTargetProperty(ay, "ScaleY");

        var sb = new Storyboard();
        sb.Children.Add(ax);
        sb.Children.Add(ay);
        sb.Begin();
    }

    private void AnimateOpacity(UIElement element, double from, double to, int ms)
    {
        var a = new DoubleAnimation
        {
            From = from,
            To = to,
            Duration = TimeSpan.FromMilliseconds(ms),
            EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseOut }
        };
        Storyboard.SetTarget(a, element);
        Storyboard.SetTargetProperty(a, "Opacity");

        var sb = new Storyboard();
        sb.Children.Add(a);
        sb.Begin();
    }

    private void OnNavSelectionChanged(Microsoft.UI.Xaml.Controls.NavigationView sender,
                                       Microsoft.UI.Xaml.Controls.NavigationViewSelectionChangedEventArgs args)
    {
        if (_isDownloading)
        {
            DispatcherQueue.TryEnqueue(() =>
                sender.SelectedItem = sender.MenuItems.FirstOrDefault(mi =>
                    (mi as Microsoft.UI.Xaml.Controls.NavigationViewItem)?.Tag as string == "home"));
            return;
        }

        var tag = (args.SelectedItem as Microsoft.UI.Xaml.Controls.NavigationViewItem)?.Tag as string;
        if (tag == null) return;

        ShowSection(tag);

        if (tag == "settings")
        {
            HookSettingsControlsLoaded();
            TryInitializeSettingsUI();
        }
    }

    private void ShowSection(string tag)
    {
        void SetVisible(Grid? g, bool visible)
        {
            if (g == null) return;
            g.Visibility = visible ? Visibility.Visible : Visibility.Collapsed;

            var anim = new DoubleAnimation
            {
                From = visible ? 0 : 1,
                To = visible ? 1 : 0,
                Duration = TimeSpan.FromMilliseconds(220),
                EasingFunction = new QuadraticEase { EasingMode = visible ? EasingMode.EaseOut : EasingMode.EaseIn }
            };
            Storyboard.SetTarget(anim, g);
            Storyboard.SetTargetProperty(anim, "Opacity");

            var sb = new Storyboard();
            sb.Children.Add(anim);
            sb.Begin();
        }

        SetVisible(SectionHome, false);
        SetVisible(SectionSettings, false);
        SetVisible(SectionAbout, false);
        SetVisible(SectionProduct, false);

        if (tag == "home") SetVisible(SectionHome, true);
        else if (tag == "settings") SetVisible(SectionSettings, true);
        else if (tag == "about") SetVisible(SectionAbout, true);
    }

    private void PrepareConnectedAnimation(Image? sourceImage)
    {
        if (sourceImage == null) return;
        var svc = ConnectedAnimationService.GetForCurrentView();
        svc.PrepareToAnimate("cardCover", sourceImage);
    }

    private void StartConnectedAnimationToHeroWhenReady()
    {
        var svc = ConnectedAnimationService.GetForCurrentView();
        var anim = svc.GetAnimation("cardCover");
        if (anim is null || ProductHeroCover == null || SectionProduct == null) return;

        if (SectionProduct.Visibility == Visibility.Visible &&
            (ProductHeroCover.ActualWidth > 0 || ProductHeroCover.IsLoaded))
        {
            anim.TryStart(ProductHeroCover);
            return;
        }

        RoutedEventHandler? sectionHandler = null;
        sectionHandler = (s, e) =>
        {
            SectionProduct.Loaded -= sectionHandler;

            RoutedEventHandler? heroHandler = null;
            heroHandler = (s2, e2) =>
            {
                ProductHeroCover.Loaded -= heroHandler;
                anim.TryStart(ProductHeroCover);
            };

            if (ProductHeroCover.IsLoaded) anim.TryStart(ProductHeroCover);
            else ProductHeroCover.Loaded += heroHandler;
        };

        if (SectionProduct.IsLoaded) sectionHandler.Invoke(SectionProduct, new RoutedEventArgs());
        else SectionProduct.Loaded += sectionHandler;
    }

    private void OnOpenProduct112Release(object? sender, RoutedEventArgs e)
    {
        if (_isDownloading) return;

        _currentProduct = ProductId.Night112Release;
        PrepareConnectedAnimation(Cover112);

        OpenProductPage(
            title: "NightDLC 1.1.2 Release",
            subtitle: "Стабильная сборка 1.16.5",
            icon: "ms-appx:///assets/night.jpg",
            hero: "ms-appx:///assets/1.1.2/1.png",
            screenshots: new[]
            {
                "ms-appx:///assets/1.1.2/1.png",
                "ms-appx:///assets/1.1.2/2.png",
                "ms-appx:///assets/1.1.2/3.png"
            },
            description: _desc112
        );

        StartConnectedAnimationToHeroWhenReady();
        _ = RefreshPrimaryActionStateAsync();
        _ = RefreshDownloadUiVisibilityAsync();
    }

    private void OnOpenProduct113Client(object? sender, RoutedEventArgs e)
    {
        if (_isDownloading) return;

        _currentProduct = ProductId.Night113Client;
        PrepareConnectedAnimation(Cover113);

        OpenProductPage(
            title: "NightDLC 1.1.3 Client",
            subtitle: "Последняя версия 1.16.5",
            icon: "ms-appx:///assets/night.jpg",
            hero: "ms-appx:///assets/1.1.3/1.png",
            screenshots: new[]
            {
                "ms-appx:///assets/1.1.3/1.png",
                "ms-appx:///assets/1.1.3/2.png",
                "ms-appx:///assets/1.1.3/3.png"
            },
            description: _desc113
        );

        StartConnectedAnimationToHeroWhenReady();
        _ = RefreshPrimaryActionStateAsync();
        _ = RefreshDownloadUiVisibilityAsync();
    }

    private void OpenProductPage(string title, string subtitle, string icon, string hero, string[] screenshots, string description)
    {
        ProductTitle_Header?.SetValue(TextBlock.TextProperty, title);
        ProductSubtitle_Header?.SetValue(TextBlock.TextProperty, subtitle);

        if (ProductIcon != null) ProductIcon.Source = new BitmapImage(new Uri(icon));
        if (ProductHeroCover != null) ProductHeroCover.Source = new BitmapImage(new Uri(hero));

        if (Shot1 != null) Shot1.Source = new BitmapImage(new Uri(screenshots[0]));
        if (Shot2 != null) Shot2.Source = new BitmapImage(new Uri(screenshots[1]));
        if (Shot3 != null) Shot3.Source = new BitmapImage(new Uri(screenshots[2]));
        _currentScreenshots = screenshots.ToList();

        if (ProductDescriptionCollapsed != null) ProductDescriptionCollapsed.Text = description;
        if (ProductDescriptionFull != null) ProductDescriptionFull.Text = description;

        if (ProductDescriptionCollapsed != null) ProductDescriptionCollapsed.Visibility = Visibility.Visible;
        if (ProductDescriptionFull != null) ProductDescriptionFull.Visibility = Visibility.Collapsed;
        if (ShowMoreButton != null) ShowMoreButton.Content = "Показать больше";

        if (SectionHome != null) SectionHome.Visibility = Visibility.Collapsed;

        if (SectionProduct != null)
        {
            SectionProduct.Visibility = Visibility.Visible;
            var fadeIn = new DoubleAnimation
            {
                From = 0,
                To = 1,
                Duration = TimeSpan.FromMilliseconds(240),
                EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseOut }
            };
            Storyboard.SetTarget(fadeIn, SectionProduct);
            Storyboard.SetTargetProperty(fadeIn, "Opacity");
            var sb = new Storyboard();
            sb.Children.Add(fadeIn);
            sb.Begin();
        }
    }

    private async Task<ContentDialogResult> ShowDialogAsync(ContentDialog dialog)
    {
        await DialogLock.WaitAsync().ConfigureAwait(true);
        try
        {
            if (Content is FrameworkElement fe && fe.XamlRoot != null)
                dialog.XamlRoot = fe.XamlRoot;

            dialog.DefaultButton = ContentDialogButton.Primary;
            return await dialog.ShowAsync();
        }
        finally
        {
            DialogLock.Release();
        }
    }

    private async void OnEditAllocForProduct(object? sender, RoutedEventArgs e)
    {
        string tag = _currentProduct == ProductId.Night113Client ? "v113" :
                     _currentProduct == ProductId.Night112Release ? "v112" : "none";

        if (tag == "none")
        {
            var infoDialog = new ContentDialog
            {
                Title = "Редактировать ОЗУ",
                Content = new TextBlock
                {
                    Text = "Сначала выберите продукт.",
                    TextWrapping = TextWrapping.WrapWholeWords,
                    TextAlignment = TextAlignment.Left
                },
                CloseButtonText = "Отмена"
            };
            await ShowDialogAsync(infoDialog);
            return;
        }

        int current = tag == "v113" ? _allocGb113 : _allocGb112;
        int totalGb = BytesToGb(_totalRamBytes);
        int minGb = 1;
        int maxGb = AllocSlider != null ? (int)AllocSlider.Maximum : Math.Max(8, Math.Min(64, totalGb));

        var page = new AllocContentPage(minGb, maxGb, current, totalGb);
        var allocDialog = new ContentDialog
        {
            Title = "Выбор ОЗУ для запуска",
            Content = page,
            PrimaryButtonText = "Сохранить",
            SecondaryButtonText = "Не сохранять",
            CloseButtonText = "Отмена"
        };

        var res = await ShowDialogAsync(allocDialog);
        if (res == ContentDialogResult.Primary)
        {
            int gbRounded = (int)Math.Round(page.Slider.Value);
            if (tag == "v113") _allocGb113 = gbRounded; else _allocGb112 = gbRounded;

            var currentTag = (VersionSelect?.SelectedItem as ComboBoxItem)?.Tag as string ?? "v112";
            if (AllocSlider != null && currentTag == tag)
            {
                double clamped = Math.Max(AllocSlider.Minimum, Math.Min(AllocSlider.Maximum, gbRounded));
                AllocSlider.Value = clamped;
                UpdateAllocLabelsAndWarnings();
            }

            await UpdateBatRamForSelectedVersionIfInstalledAsync();
        }
    }

    private async Task UpdateBatRamForSelectedVersionIfInstalledAsync()
    {
        string tag = (VersionSelect?.SelectedItem as ComboBoxItem)?.Tag as string ?? "v112";
        bool installed = tag == "v112"
            ? Directory.Exists(Path112) && File.Exists(Bat112)
            : Directory.Exists(Path113) && File.Exists(Bat113);

        if (!installed) return;

        int gb = tag == "v112" ? _allocGb112 : _allocGb113;
        string bat = tag == "v112" ? Bat112 : Bat113;

        await UpdateBatRamAsync(bat, gb);
    }

    private void OnProductMenuClick(object? sender, RoutedEventArgs e)
    {
        var fe = sender as FrameworkElement;
        if (fe == null) return;

        var menu = new MenuFlyout();

        var openFolder = new MenuFlyoutItem { Text = "Открыть папку" };
        openFolder.Icon = new FontIcon { FontFamily = new FontFamily("Segoe Fluent Icons"), Glyph = "\uE8B7" };

        var openConfigs = new MenuFlyoutItem { Text = "Конфиг" };
        openConfigs.Icon = new FontIcon { FontFamily = new FontFamily("Segoe Fluent Icons"), Glyph = "\uE8CE" };

        bool exists112 = Directory.Exists(Path112) && File.Exists(Bat112);
        bool exists113 = Directory.Exists(Path113) && File.Exists(Bat113);
        bool existsCurrent = _currentProduct == ProductId.Night112Release ? exists112 :
                             _currentProduct == ProductId.Night113Client ? exists113 : false;

        MenuFlyoutItem? deleteVersion = null;
        if (existsCurrent)
        {
            deleteVersion = new MenuFlyoutItem { Text = "Удалить версию" };
            deleteVersion.Icon = new FontIcon
            {
                FontFamily = new FontFamily("Segoe Fluent Icons"),
                Glyph = "\uE74D",
                Foreground = new SolidColorBrush(Microsoft.UI.Colors.Red)
            };
            deleteVersion.Foreground = new SolidColorBrush(Microsoft.UI.Colors.Red);
        }

        openFolder.Click += async (s, ev) =>
        {
            string root = _currentProduct == ProductId.Night112Release ? Path112 :
                          _currentProduct == ProductId.Night113Client ? Path113 : string.Empty;

            if (string.IsNullOrEmpty(root))
            {
                await ShowDialogAsync(new ContentDialog
                {
                    Title = "Открыть папку",
                    Content = new TextBlock
                    {
                        Text = "Сначала выберите продукт.",
                        TextWrapping = TextWrapping.WrapWholeWords,
                        TextAlignment = TextAlignment.Left
                    },
                    CloseButtonText = "ОК"
                });
                return;
            }

            if (!Directory.Exists(root))
            {
                await ShowDialogAsync(new ContentDialog
                {
                    Title = "Папка отсутствует",
                    Content = new TextBlock
                    {
                        Text = "Папка не найдена. Нажмите «Скачать» на карточке продукта.",
                        TextWrapping = TextWrapping.WrapWholeWords,
                        TextAlignment = TextAlignment.Left
                    },
                    CloseButtonText = "ОК"
                });
                return;
            }

            TryOpenFolder(root);
        };

        openConfigs.Click += async (s, ev) =>
        {
            string config = _currentProduct == ProductId.Night112Release
                ? IOPath.Combine(Path112, "nightdlc", "config")
                : _currentProduct == ProductId.Night113Client
                    ? IOPath.Combine(Path113, "nightdlc", "config")
                    : string.Empty;

            if (string.IsNullOrEmpty(config))
            {
                await ShowDialogAsync(new ContentDialog
                {
                    Title = "Конфиг",
                    Content = new TextBlock
                    {
                        Text = "Сначала выберите продукт.",
                        TextWrapping = TextWrapping.WrapWholeWords,
                        TextAlignment = TextAlignment.Left
                    },
                    CloseButtonText = "ОК"
                });
                return;
            }

            if (!Directory.Exists(config))
            {
                await ShowDialogAsync(new ContentDialog
                {
                    Title = "Папка отсутствует",
                    Content = new TextBlock
                    {
                        Text = "Папка конфигов не найдена. Убедитесь, что клиент установлен.",
                        TextWrapping = TextWrapping.WrapWholeWords,
                        TextAlignment = TextAlignment.Left
                    },
                    CloseButtonText = "ОК"
                });
                return;
            }

            TryOpenFolder(config);
        };

        if (deleteVersion != null)
        {
            deleteVersion.Click += async (s, ev) =>
            {
                string root = _currentProduct == ProductId.Night112Release ? Path112 :
                              _currentProduct == ProductId.Night113Client ? Path113 : string.Empty;

                if (string.IsNullOrEmpty(root) ||
                    !Directory.Exists(root) ||
                    !File.Exists(_currentProduct == ProductId.Night112Release ? Bat112 : Bat113))
                {
                    await ShowDialogAsync(new ContentDialog
                    {
                        Title = "Удаление версии",
                        Content = new TextBlock
                        {
                            Text = "Версия не установлена или папка отсутствует.",
                            TextWrapping = TextWrapping.WrapWholeWords,
                            TextAlignment = TextAlignment.Left
                        },
                        CloseButtonText = "ОК"
                    });
                    return;
                }

                var confirm = new ContentDialog
                {
                    Title = "Подтверждение удаления",
                    Content = new TextBlock
                    {
                        Text = $"Удалить папку версии?\r\n{root}",
                        TextWrapping = TextWrapping.WrapWholeWords,
                        TextAlignment = TextAlignment.Left
                    },
                    PrimaryButtonText = "Удалить",
                    CloseButtonText = "Отмена"
                };

                var res = await ShowDialogAsync(confirm);
                if (res == ContentDialogResult.Primary)
                {
                    bool ok = await Task.Run(() =>
                    {
                        try { SafeDeleteDirectory(root); return true; }
                        catch { return false; }
                    });

                    if (ok)
                    {
                        await ShowDialogAsync(new ContentDialog
                        {
                            Title = "Удалено",
                            Content = new TextBlock
                            {
                                Text = "Версия удалена.",
                                TextWrapping = TextWrapping.WrapWholeWords,
                                TextAlignment = TextAlignment.Left
                            },
                            CloseButtonText = "ОК"
                        });

                        await RefreshPrimaryActionStateAsync();
                    }
                    else
                    {
                        await ShowDialogAsync(new ContentDialog
                        {
                            Title = "Ошибка удаления",
                            Content = new TextBlock
                            {
                                Text = "Не удалось удалить папку версии.",
                                TextWrapping = TextWrapping.WrapWholeWords,
                                TextAlignment = TextAlignment.Left
                            },
                            CloseButtonText = "ОК"
                        });
                    }
                }
            };
        }

        menu.Items.Add(openFolder);
        menu.Items.Add(openConfigs);
        if (deleteVersion != null) menu.Items.Add(deleteVersion);

        if (SectionAbout?.IsLoaded == true && SectionAbout.Visibility == Visibility.Visible)
            menu.ShowAt(SectionAbout);
        else if (fe != null) menu.ShowAt(fe);
        else menu.ShowAt(this);
    }

    private static void TryOpenFolder(string path)
    {
        try
        {
            Process.Start(new ProcessStartInfo { FileName = path, UseShellExecute = true });
        }
        catch { }
    }

    [StructLayout(LayoutKind.Sequential)]
    private struct MEMORYSTATUSEX
    {
        public uint dwLength;
        public uint dwMemoryLoad;
        public ulong ullTotalPhys;
        public ulong ullAvailPhys;
        public ulong ullTotalPageFile;
        public ulong ullAvailPageFile;
        public ulong ullTotalVirtual;
        public ulong ullAvailVirtual;
        public ulong ullAvailExtendedVirtual;
    }

    [DllImport("kernel32.dll")]
    private static extern bool GlobalMemoryStatusEx(ref MEMORYSTATUSEX lpBuffer);

    private static ulong GetTotalPhysicalMemory()
    {
        MEMORYSTATUSEX status = new() { dwLength = (uint)Marshal.SizeOf<MEMORYSTATUSEX>() };
        return GlobalMemoryStatusEx(ref status) ? status.ullTotalPhys : 0UL;
    }

    private void EnsureStarsInitialized()
    {
        if (_starsInitialized) return;
        _starsInitialized = true;

        if (StarsCanvas == null) return;

        CreateStars(StarsCanvas, 280);
        ResetStarsPositions();
    }

    private void CreateStars(Canvas canvas, int count)
    {
        canvas.Children.Clear();
        _stars.Clear();

        for (int i = 0; i < count; i++)
        {
            int size = _rand.Next(1, 3);
            var star = new Ellipse
            {
                Width = size,
                Height = size,
                Fill = new SolidColorBrush(Microsoft.UI.Colors.White),
                Opacity = 0.75 + _rand.NextDouble() * 0.25
            };
            // [baseOpacity, amplitude, frequency, phase, drift]
            star.Tag = new double[]
            {
                0.75 + _rand.NextDouble() * 0.25,
                0.35 + _rand.NextDouble() * 0.45,
                16.0 + _rand.NextDouble() * 20.0,
                _rand.NextDouble() * Math.PI * 2,
                0.025 + _rand.NextDouble() * 0.055
            };
            _stars.Add(star);
            canvas.Children.Add(star);
        }
    }

    private void ResetStarsPositions()
    {
        if (StarsCanvas == null || _stars.Count == 0) return;
        double width = Math.Max(1, StarsCanvas.ActualWidth);
        double height = Math.Max(1, StarsCanvas.ActualHeight);
        for (int i = 0; i < _stars.Count; i++)
        {
            var star = _stars[i];
            Canvas.SetLeft(star, _rand.NextDouble() * width);
            Canvas.SetTop(star, _rand.NextDouble() * height);
        }
    }

    private void OnStarsRender(object? sender, object e)
    {
        if (StarsCanvas == null || _stars.Count == 0) return;

        double width = StarsCanvas.ActualWidth;
        double height = StarsCanvas.ActualHeight;
        if (width <= 0 || height <= 0) return;

        for (int i = 0; i < _stars.Count; i++)
        {
            var star = _stars[i];
            var data = star.Tag as double[];
            if (data == null || data.Length < 5) continue;

            double baseOpacity = data[0], amp = data[1], freq = data[2], phase = data[3], drift = data[4];

            double top = Canvas.GetTop(star);
            double left = Canvas.GetLeft(star);

            double twinkle = Math.Sin((top + phase) / freq) * amp;
            star.Opacity = Math.Max(0.35, Math.Min(1.0, baseOpacity + twinkle));

            double newTop = top + drift;
            if (newTop > height)
            {
                newTop = -_rand.NextDouble() * 20.0;
                left = _rand.NextDouble() * width;
            }
            Canvas.SetTop(star, newTop);
            Canvas.SetLeft(star, left);
        }
    }

    private sealed class AllocContentPage : Page
    {
        public Slider Slider { get; }
        public TextBlock Label { get; }
        public InfoBar WarningBar { get; }
        public InfoBar ErrorBar { get; }

        public AllocContentPage(int minGb, int maxGb, int currentGb, int totalGb)
        {
            var root = new StackPanel
            {
                VerticalAlignment = VerticalAlignment.Stretch,
                HorizontalAlignment = HorizontalAlignment.Stretch,
                Spacing = 8
            };

            var title = new TextBlock
            {
                Text = "Выделение ОЗУ для запуска",
                FontSize = 16,
                TextAlignment = TextAlignment.Left
            };

            Label = new TextBlock
            {
                TextWrapping = TextWrapping.WrapWholeWords,
                TextAlignment = TextAlignment.Left
            };

            Slider = new Slider
            {
                Minimum = minGb,
                Maximum = maxGb,
                Value = currentGb,
                SmallChange = 1,
                LargeChange = 2
            };

            WarningBar = new InfoBar
            {
                IsOpen = false,
                IsClosable = true,
                Severity = InfoBarSeverity.Warning,
                Title = "Предупреждение",
                Message = "Выделено более 50% ОЗУ. Рекомендуется уменьшить."
            };

            ErrorBar = new InfoBar
            {
                IsOpen = false,
                IsClosable = true,
                Severity = InfoBarSeverity.Error,
                Title = "Высокое выделение памяти",
                Message = "Выделено более 80% ОЗУ. Рекомендуется уменьшить."
            };

            void Update()
            {
                int gb = (int)Math.Round(Slider.Value);
                double percent = totalGb > 0 ? (gb / (double)totalGb) * 100.0 : 0.0;
                Label.Text = $"Выделение: {gb} ГБ ({percent:0}% от {totalGb} ГБ)";
                WarningBar.IsOpen = percent > 50.0 && percent <= 80.0;
                ErrorBar.IsOpen = percent > 80.0;
            }

            Slider.ValueChanged += (s, e) => Update();
            Update();

            root.Children.Add(title);
            root.Children.Add(Label);
            root.Children.Add(Slider);
            root.Children.Add(WarningBar);
            root.Children.Add(ErrorBar);
            Content = root;
        }
    }

    private void OnShotTapped(object? sender, TappedRoutedEventArgs e)
    {
        if (_currentScreenshots.Count == 0) return;

        int startIndex = 0;
        if (sender is Image img && img.Source is BitmapImage bi)
        {
            var s = bi.UriSource?.ToString();
            int found = _currentScreenshots.IndexOf(s ?? string.Empty);
            if (found >= 0) startIndex = found;
        }

        OpenOverlay(startIndex);
    }

    private void OpenOverlay(int index)
    {
        _overlayIndex = Math.Max(0, Math.Min(_currentScreenshots.Count - 1, index));
        UpdateOverlayImage();

        if (ScreenshotOverlay == null) return;

        ScreenshotOverlay.Visibility = Visibility.Visible;
        ScreenshotOverlay.IsHitTestVisible = true;

        var fadeIn = new DoubleAnimation
        {
            From = 0,
            To = 1,
            Duration = TimeSpan.FromMilliseconds(160),
            EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseOut }
        };
        Storyboard.SetTarget(fadeIn, ScreenshotOverlay);
        Storyboard.SetTargetProperty(fadeIn, "Opacity");
        var sb = new Storyboard();
        sb.Children.Add(fadeIn);
        sb.Begin();

        OverlayCloseBtn?.Focus(FocusState.Programmatic);
    }

    private void CloseOverlay()
    {
        if (ScreenshotOverlay == null) return;

        var fadeOut = new DoubleAnimation
        {
            From = 1,
            To = 0,
            Duration = TimeSpan.FromMilliseconds(140),
            EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseIn }
        };
        fadeOut.Completed += (s, e) =>
        {
            ScreenshotOverlay.Visibility = Visibility.Collapsed;
            ScreenshotOverlay.IsHitTestVisible = false;
        };
        Storyboard.SetTarget(fadeOut, ScreenshotOverlay);
        Storyboard.SetTargetProperty(fadeOut, "Opacity");
        var sb = new Storyboard();
        sb.Children.Add(fadeOut);
        sb.Begin();
    }

    private void UpdateOverlayImage()
    {
        if (_currentScreenshots.Count == 0 || OverlayImage == null || OverlayCounter == null) return;

        string uri = _currentScreenshots[_overlayIndex];
        OverlayImage.Source = new BitmapImage(new Uri(uri));
        OverlayCounter.Text = $"{_overlayIndex + 1} / {_currentScreenshots.Count}";
    }

    private void OverlayStep(int dir)
    {
        if (_currentScreenshots.Count == 0) return;
        _overlayIndex = (_overlayIndex + dir + _currentScreenshots.Count) % _currentScreenshots.Count;
        UpdateOverlayImage();
    }

    private void OnOverlayClose(object? sender, RoutedEventArgs e) => CloseOverlay();
    private void OnOverlayPrev(object? sender, RoutedEventArgs e) => OverlayStep(-1);
    private void OnOverlayNext(object? sender, RoutedEventArgs e) => OverlayStep(1);

    private async void OnPrimaryActionClick(object? sender, RoutedEventArgs e)
    {
        if (_currentProduct == ProductId.None) return;
        if (_isDownloading) return;

        bool exists = await ProductExistsAsync(_currentProduct);
        var nav = NavView;

        if (!exists)
        {
            _isDownloading = true;
            _downloadCts = new CancellationTokenSource();

            await ShowDownloadContainerAnimatedAsync(show: true);

            if (nav != null) nav.IsEnabled = false;
            await DownloadAndInstallAsync(_currentProduct, _downloadCts.Token);
            if (nav != null) nav.IsEnabled = true;

            await RefreshPrimaryActionStateAsync();
            await UpdateBatRamForCurrentProductAsync();
            await ShowDownloadContainerAnimatedAsync(show: false);

            _isDownloading = false;
            _downloadCts = null;
            return;
        }

        await UpdateBatRamForCurrentProductAsync();
        await LaunchProductAsync(_currentProduct);
    }

    private async Task RefreshPrimaryActionStateAsync()
    {
        bool exists = await ProductExistsAsync(_currentProduct);
        if (PrimaryActionIcon == null || PrimaryActionText == null || LaunchOrDownloadButton == null) return;

        if (exists)
        {
            PrimaryActionIcon.Glyph = "\uE768";
            PrimaryActionText.Text = "Запустить";
            ToolTipService.SetToolTip(LaunchOrDownloadButton, "Запустить клиент");
        }
        else
        {
            PrimaryActionIcon.Glyph = "\uE896";
            PrimaryActionText.Text = "Скачать";
            ToolTipService.SetToolTip(LaunchOrDownloadButton, "Скачать и установить клиент");
        }
    }

    private Task<bool> ProductExistsAsync(ProductId id)
    {
        return Task.Run(() =>
        {
            try
            {
                string root = id == ProductId.Night112Release ? Path112 :
                              id == ProductId.Night113Client ? Path113 : string.Empty;
                if (string.IsNullOrEmpty(root)) return false;

                string bat = id == ProductId.Night112Release ? Bat112 : Bat113;
                return Directory.Exists(root) && File.Exists(bat);
            }
            catch { return false; }
        });
    }

    private void ResetDownloadUi()
    {
        if (DownloadContainerBorder == null || DownloadProgressBar == null ||
            DownloadProgressText == null || DownloadSpeedText == null || DownloadEtaText == null)
            return;

        DownloadContainerBorder.Visibility = Visibility.Collapsed;
        DownloadContainerBorder.Opacity = 0;

        DownloadProgressBar.Value = 0;
        DownloadProgressText.Text = "0.00 / 0.00 MB (0%)";
        DownloadSpeedText.Text = "Скорость: 0.00 MB/s";
        DownloadEtaText.Text = "Осталось: —";
    }

    private Task RefreshDownloadUiVisibilityAsync()
    {
        DispatcherQueue.TryEnqueue(ResetDownloadUi);
        return Task.CompletedTask;
    }

    private Task ShowDownloadContainerAnimatedAsync(bool show)
    {
        DispatcherQueue.TryEnqueue(() =>
        {
            if (DownloadContainerBorder == null) return;

            if (show)
            {
                DownloadContainerBorder.Visibility = Visibility.Visible;
                var fadeIn = new DoubleAnimation
                {
                    From = 0,
                    To = 1,
                    Duration = TimeSpan.FromMilliseconds(200),
                    EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseOut }
                };
                Storyboard.SetTarget(fadeIn, DownloadContainerBorder);
                Storyboard.SetTargetProperty(fadeIn, "Opacity");
                var sb = new Storyboard();
                sb.Children.Add(fadeIn);
                sb.Begin();
            }
            else
            {
                var fadeOut = new DoubleAnimation
                {
                    From = DownloadContainerBorder.Opacity,
                    To = 0,
                    Duration = TimeSpan.FromMilliseconds(180),
                    EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseIn }
                };
                fadeOut.Completed += (s, e) => { ResetDownloadUi(); };

                Storyboard.SetTarget(fadeOut, DownloadContainerBorder);
                Storyboard.SetTargetProperty(fadeOut, "Opacity");
                var sb = new Storyboard();
                sb.Children.Add(fadeOut);
                sb.Begin();
            }
        });

        return Task.CompletedTask;
    }

    private Task UpdateDownloadUiAsync(double downloadedMb, double totalMb, double percent, double speedMbPerSec, TimeSpan? eta)
    {
        DispatcherQueue.TryEnqueue(() =>
        {
            if (DownloadProgressBar != null) DownloadProgressBar.Value = percent;
            if (DownloadProgressText != null) DownloadProgressText.Text = $"{downloadedMb:0.00} / {totalMb:0.00} MB ({percent:0}% )";
            if (DownloadSpeedText != null) DownloadSpeedText.Text = $"Скорость: {speedMbPerSec:0.00} MB/s";
            if (DownloadEtaText != null) DownloadEtaText.Text = $"Осталось: {(eta.HasValue ? $"{(int)eta.Value.TotalMinutes} мин {eta.Value.Seconds} сек" : "—")}";
        });

        return Task.CompletedTask;
    }

    private static string SystemRoot => IOPath.GetPathRoot(Environment.SystemDirectory) ?? "C:\\";
    private static string Path112 => IOPath.Combine(SystemRoot, "NightDLC");
    private static string Path113 => IOPath.Combine(SystemRoot, "NightDLC1.1.3");
    private static string BatFileName => "NightDLC.bat";
    private static string Bat112 => IOPath.Combine(Path112, BatFileName);
    private static string Bat113 => IOPath.Combine(Path113, BatFileName);

    private const string Url112 = "https://github.com/AlexanderBichpochmak/fileff/releases/download/v.1_1_2/NightDLC.zip";
    private const string Url113 = "https://github.com/AlexanderBichpochmak/fileff/releases/download/v.1_1_3/NightDLC1.1.3.zip";

    private async Task DownloadAndInstallAsync(ProductId id, CancellationToken ct)
    {
        string url = id == ProductId.Night112Release ? Url112 : Url113;
        string root = id == ProductId.Night112Release ? Path112 : Path113;

        string tmpDir = IOPath.Combine(IOPath.GetTempPath(), "NightDLC_tmp");
        Directory.CreateDirectory(tmpDir);

        string zipPath = IOPath.Combine(tmpDir, $"nightdlc_{Guid.NewGuid():N}.zip");

        try
        {
            using var req = new HttpRequestMessage(HttpMethod.Get, url);
            using var resp = await Http.SendAsync(req, HttpCompletionOption.ResponseHeadersRead, ct);
            resp.EnsureSuccessStatusCode();

            long? contentLength = resp.Content.Headers.ContentLength;

            await using Stream src = await resp.Content.ReadAsStreamAsync(ct);
            await using var dst = new FileStream(zipPath, FileMode.Create, FileAccess.Write, FileShare.Read, bufferSize: 1 << 16, FileOptions.Asynchronous);

            var buffer = new byte[1 << 16];
            long totalRead = 0;
            var sw = Stopwatch.StartNew();
            long lastReportRead = 0;
            var lastReportTime = sw.Elapsed;

            double totalMb = contentLength.HasValue ? contentLength.Value / (1024.0 * 1024.0) : 0.0;

            while (true)
            {
                ct.ThrowIfCancellationRequested();
                int read = await src.ReadAsync(buffer.AsMemory(0, buffer.Length), ct);
                if (read == 0) break;

                await dst.WriteAsync(buffer.AsMemory(0, read), ct);
                totalRead += read;

                var now = sw.Elapsed;
                if ((now - lastReportTime).TotalMilliseconds >= 200 ||
                    (contentLength.HasValue && totalRead == contentLength.Value))
                {
                    double downloadedMb = totalRead / (1024.0 * 1024.0);
                    double percent = contentLength.HasValue && totalMb > 0
                        ? Math.Max(0, Math.Min(100, downloadedMb / totalMb * 100.0))
                        : 0.0;

                    double deltaMb = (totalRead - lastReportRead) / (1024.0 * 1024.0);
                    double deltaSec = (now - lastReportTime).TotalSeconds;
                    double speed = deltaSec > 0 ? deltaMb / deltaSec : 0.0;

                    TimeSpan? eta = null;
                    if (contentLength.HasValue && speed > 0 && totalMb > 0)
                    {
                        double leftMb = totalMb - downloadedMb;
                        eta = TimeSpan.FromSeconds(Math.Max(0, leftMb / speed));
                    }

                    await UpdateDownloadUiAsync(downloadedMb, totalMb, percent, speed, eta);

                    lastReportRead = totalRead;
                    lastReportTime = now;
                }
            }

            await dst.FlushAsync(ct);
            await dst.DisposeAsync();

            if (Directory.Exists(root))
            {
                SafeDeleteDirectory(root);
            }
            Directory.CreateDirectory(root);

            string unzipTemp = IOPath.Combine(tmpDir, $"unzipped_{Guid.NewGuid():N}");
            Directory.CreateDirectory(unzipTemp);

            ZipFile.ExtractToDirectory(zipPath, unzipTemp);

            var candidates = Directory.GetDirectories(unzipTemp);
            if (candidates.Length == 1 && Directory.GetFiles(unzipTemp).Length == 0)
            {
                CopyDirectoryRecursively(candidates[0], root);
            }
            else
            {
                CopyDirectoryRecursively(unzipTemp, root);
            }

            string bat = id == ProductId.Night112Release ? Bat112 : Bat113;
            if (!File.Exists(bat))
            {
                string content = "@echo off\r\nREM Start client with RAM\r\njavaw -Xmx4G -noverify -jar \"%~dp0client.jar\"";
                await File.WriteAllTextAsync(bat, content, Encoding.UTF8, ct);
            }

            await UpdateBatRamForCurrentProductAsync();

            await ShowDialogAsync(new ContentDialog
            {
                Title = "Установка завершена",
                Content = new TextBlock
                {
                    Text = "Клиент установлен. Можно запускать.",
                    TextWrapping = TextWrapping.WrapWholeWords,
                    TextAlignment = TextAlignment.Left
                },
                CloseButtonText = "ОК"
            });
        }
        catch (OperationCanceledException)
        {
            // отменено
        }
        catch (Exception ex)
        {
            await ShowDialogAsync(new ContentDialog
            {
                Title = "Ошибка установки",
                Content = new TextBlock
                {
                    Text = $"Не удалось установить клиент: {ex.Message}",
                    TextWrapping = TextWrapping.WrapWholeWords,
                    TextAlignment = TextAlignment.Left
                },
                CloseButtonText = "ОК"
            });
        }
        finally
        {
            try { if (File.Exists(zipPath)) File.Delete(zipPath); } catch { }
            try
            {
                foreach (var dir in Directory.EnumerateDirectories(tmpDir, "unzipped_*"))
                    SafeDeleteDirectory(dir);
            }
            catch { }
        }
    }

    private static void SafeDeleteDirectory(string path)
    {
        try
        {
            if (!Directory.Exists(path)) return;

            foreach (var dir in Directory.GetDirectories(path))
                SafeDeleteDirectory(dir);

            foreach (var file in Directory.GetFiles(path))
            {
                try { File.Delete(file); } catch { }
            }

            Directory.Delete(path, true);
        }
        catch { }
    }

    private static void CopyDirectoryRecursively(string src, string dst)
    {
        foreach (var dirPath in Directory.GetDirectories(src, "*", SearchOption.AllDirectories))
        {
            var rel = IOPath.GetRelativePath(src, dirPath);
            Directory.CreateDirectory(IOPath.Combine(dst, rel));
        }

        foreach (var filePath in Directory.GetFiles(src, "*", SearchOption.AllDirectories))
        {
            var rel = IOPath.GetRelativePath(src, filePath);
            var target = IOPath.Combine(dst, rel);
            Directory.CreateDirectory(IOPath.GetDirectoryName(target)!);
            File.Copy(filePath, target, overwrite: true);
        }
    }

    private async Task UpdateBatRamForCurrentProductAsync()
    {
        try
        {
            string bat = _currentProduct == ProductId.Night112Release ? Bat112 :
                         _currentProduct == ProductId.Night113Client ? Bat113 : string.Empty;

            if (string.IsNullOrEmpty(bat) || !File.Exists(bat)) return;

            int gb = _currentProduct == ProductId.Night113Client ? _allocGb113 : _allocGb112;
            await UpdateBatRamAsync(bat, gb);
        }
        catch { }
    }

    private static async Task UpdateBatRamAsync(string batPath, int gb)
    {
        string[] lines = await File.ReadAllLinesAsync(batPath, Encoding.UTF8);
        bool changed = false;

        for (int i = 0; i < lines.Length; i++)
        {
            string line = lines[i];
            if (line.Contains("javaw", StringComparison.OrdinalIgnoreCase) &&
                line.Contains("-Xmx", StringComparison.OrdinalIgnoreCase) &&
                line.Contains("-noverify", StringComparison.OrdinalIgnoreCase) &&
                line.Contains("client.jar", StringComparison.OrdinalIgnoreCase))
            {
                lines[i] = $"javaw -Xmx{gb}G -noverify -jar \"%~dp0client.jar\"";
                changed = true;
                break;
            }
        }

        if (!changed)
        {
            var list = lines.ToList();
            list.Add($"javaw -Xmx{gb}G -noverify -jar \"%~dp0client.jar\"");
            lines = list.ToArray();
        }

        await File.WriteAllLinesAsync(batPath, lines, Encoding.UTF8);
    }

    [DllImport("user32.dll")]
    private static extern bool SetForegroundWindow(IntPtr hWnd);

    private static Process? GetJavawProcessNearNow()
    {
        try
        {
            var procs = Process.GetProcessesByName("javaw");
            return procs.OrderByDescending(p => p.StartTime).FirstOrDefault();
        }
        catch { return null; }
    }

    private async Task LaunchProductAsync(ProductId id)
    {
        try
        {
            string bat = id == ProductId.Night112Release ? Bat112 :
                         id == ProductId.Night113Client ? Bat113 : string.Empty;

            if (string.IsNullOrEmpty(bat) || !File.Exists(bat))
            {
                await ShowDialogAsync(new ContentDialog
                {
                    Title = "Файл не найден",
                    Content = new TextBlock
                    {
                        Text = "NightDLC.bat отсутствует. Установите клиент.",
                        TextWrapping = TextWrapping.WrapWholeWords,
                        TextAlignment = TextAlignment.Left
                    },
                    CloseButtonText = "ОК"
                });
                return;
            }

            string workingDir = IOPath.GetDirectoryName(bat)!;

            App.MinimizeCurrentWindow();

            var psi = new ProcessStartInfo
            {
                FileName = "cmd.exe",
                Arguments = $"/C \"{bat}\"",
                WorkingDirectory = workingDir,
                UseShellExecute = false,
                CreateNoWindow = true,
                WindowStyle = ProcessWindowStyle.Hidden
            };
            _ = Process.Start(psi);

            await BringGameToFrontWhenReadyAsync(TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(20));
            await WaitForJavawExitAsync(TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1), TimeSpan.FromMinutes(90));

            App.RestoreCurrentWindow();
        }
        catch (Exception ex)
        {
            await ShowDialogAsync(new ContentDialog
            {
                Title = "Ошибка запуска",
                Content = new TextBlock
                {
                    Text = $"Не удалось запустить: {ex.Message}",
                    TextWrapping = TextWrapping.WrapWholeWords,
                    TextAlignment = TextAlignment.Left
                },
                CloseButtonText = "ОК"
            });
        }
    }

    private static async Task BringGameToFrontWhenReadyAsync(TimeSpan initialDelay, TimeSpan pollInterval, TimeSpan maxWait)
    {
        try
        {
            var start = DateTime.UtcNow;
            await Task.Delay(initialDelay);

            while (DateTime.UtcNow - start < maxWait)
            {
                var p = GetJavawProcessNearNow();
                if (p != null)
                {
                    IntPtr hwnd = IntPtr.Zero;
                    try { hwnd = p.MainWindowHandle; } catch { }
                    if (hwnd != IntPtr.Zero)
                    {
                        try { SetForegroundWindow(hwnd); } catch { }
                        break;
                    }
                }
                await Task.Delay(pollInterval);
            }
        }
        catch { }
    }

    private static async Task WaitForJavawExitAsync(TimeSpan initialDelay, TimeSpan pollInterval, TimeSpan maxWait)
    {
        try
        {
            var start = DateTime.UtcNow;
            await Task.Delay(initialDelay);

            bool seenJavaw = false;
            while (DateTime.UtcNow - start < maxWait)
            {
                var procs = Process.GetProcessesByName("javaw");
                if (procs.Length > 0) seenJavaw = true;
                if (seenJavaw && procs.Length == 0) break;
                await Task.Delay(pollInterval);
            }
        }
        catch { }
    }

    private void OnBackToHome(object? sender, RoutedEventArgs e)
    {
        ShowSection("home");

        if (SectionProduct == null || SectionHome == null) return;

        var fadeOut = new DoubleAnimation
        {
            From = SectionProduct.Opacity,
            To = 0,
            Duration = TimeSpan.FromMilliseconds(160),
            EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseIn }
        };
        fadeOut.Completed += (s, ev) =>
        {
            SectionProduct.Visibility = Visibility.Collapsed;
            SectionHome.Visibility = Visibility.Visible;
            SectionHome.Opacity = 1.0;
        };
        Storyboard.SetTarget(fadeOut, SectionProduct);
        Storyboard.SetTargetProperty(fadeOut, "Opacity");
        var sb = new Storyboard();
        sb.Children.Add(fadeOut);
        sb.Begin();
    }

    private void OnToggleShowMore(object? sender, RoutedEventArgs e)
    {
        if (ProductDescriptionCollapsed == null || ProductDescriptionFull == null || ShowMoreButton == null) return;

        if (ProductDescriptionCollapsed.Visibility == Visibility.Visible)
        {
            ProductDescriptionCollapsed.Visibility = Visibility.Collapsed;
            ProductDescriptionFull.Visibility = Visibility.Visible;
            ShowMoreButton.Content = "Показать меньше";
        }
        else
        {
            ProductDescriptionCollapsed.Visibility = Visibility.Visible;
            ProductDescriptionFull.Visibility = Visibility.Collapsed;
            ShowMoreButton.Content = "Показать больше";
        }
    }

    // Автор: контекстное меню только Telegram CodeVerse
    private void OnAuthorHyperlinkClick(Hyperlink sender, HyperlinkClickEventArgs args)
    {
        var menu = new MenuFlyout();

        var telegramCodeVerse = new MenuFlyoutItem { Text = "Telegram CodeVerse" };
        telegramCodeVerse.Click += (s, e) =>
        {
            try { Process.Start(new ProcessStartInfo { FileName = "https://t.me/codeverse_official", UseShellExecute = true }); } catch { }
        };

        menu.Items.Add(telegramCodeVerse);

        if (AuthorTextBlock is FrameworkElement fe)
            menu.ShowAt(fe);
        else
            menu.ShowAt(this);
    }
}
